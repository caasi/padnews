// Generated by LiveScript 1.2.0
var request, ent, deepDiff, moment, Padnews;
request = require('request');
ent = require('ent');
deepDiff = require('deep-diff');
moment = require('moment');
Padnews = (function(){
  Padnews.displayName = 'Padnews';
  var padZero, regex, prototype = Padnews.prototype, constructor = Padnews;
  padZero = function(it){
    if (it.length === 1) {
      return "0" + it;
    } else {
      return it;
    }
  };
  regex = {
    date: /^\s*(\d?\d)\s*月\s*(\d?\d)\s*日\s*$/,
    splitter: /(<\/p>|<p>)/,
    tags: /<[^<]*>/gi,
    entry: /^\s*(\d?\d:\S\S)\s*(?:\[\s*([^\[]*)\s*\])?\s*(.+)\s*/,
    newline: /\r?\n/
  };
  function Padnews(id, domain, apiClient){
    this.id = id;
    this.domain = domain;
    this.apiClient = apiClient;
    this.run = bind$(this, 'run', prototype);
    this.get = bind$(this, 'get', prototype);
    this.getByApi = bind$(this, 'getByApi', prototype);
    this.domain = this.domain ? domain + "." : '';
    this.delay = 5000;
    this.prev = [];
    this.news = [];
    this.year = new Date().getFullYear();
  }
  prototype.getByApi = function(err, data){
    this.get(err, null, data);
  };
  prototype.get = function(err, res, body){
    var last, i$, ref$, len$, line, date, j$, ref1$, len1$, entry, news;
    if (err || res.statusCode !== 200) {
      return;
    }
    this.prev = this.news;
    this.news = [];
    for (i$ = 0, len$ = (ref$ = body.split(regex.splitter)).length; i$ < len$; ++i$) {
      line = ref$[i$];
      line = line.replace(regex.tags, '');
      line = ent.decode(line);
      date = regex.date.exec(line);
      if (date) {
        for (j$ = 0, len1$ = (ref1$ = this.news).length; j$ < len1$; ++j$) {
          entry = ref1$[j$];
          if (!entry.month && !entry.date) {
            entry.month = date[1];
            entry.date = date[2];
            entry.possibleTimestamp = moment(this.year + "-" + padZero(entry.month) + "-" + padZero(entry.date) + "T" + entry.time).unix();
          }
        }
        continue;
      }
      news = regex.entry.exec(line);
      if (news) {
        last = {
          month: null,
          date: null,
          time: news[1].length === 4
            ? "0" + news[1]
            : news[1],
          location: news[2] || '',
          content: [news[3]]
        };
        this.news.push(last);
      } else if (line.length && !regex.newline.test(line)) {
        if (last != null) {
          last.content.push(line);
        }
      }
    }
    this.news.reverse();
    this.didUpdate();
  };
  prototype.didUpdate = function(){
    var i$, to$, i, current, prev, ds;
    if (this.prev.length) {
      for (i$ = 0, to$ = this.news.length; i$ < to$; ++i$) {
        i = i$;
        current = this.news[i];
        prev = this.prev[i];
        if (prev) {
          ds = deepDiff.diff(current, prev);
          if (!ds) {
            continue;
          }
          if (typeof this.onMsg === 'function') {
            this.onMsg('update', current, i, ds);
          }
        } else {
          if (typeof this.onMsg === 'function') {
            this.onMsg('create', current, i);
          }
        }
      }
      for (i$ = this.prev.length - 1, to$ = this.news.length; i$ >= to$; --i$) {
        i = i$;
        prev = this.prev[i];
        if (typeof this.onMsg === 'function') {
          this.onMsg('remove', prev, i);
        }
      }
    } else if (this.news.length) {
      if (typeof this.onMsg === 'function') {
        this.onMsg('ready');
      }
    }
    setTimeout(this.run, this.delay);
  };
  prototype.run = function(){
    if (!this.apiClient) {
      request("https://" + this.domain + "hackpad.com/ep/pad/static/" + this.id, this.get);
    } else {
      this.apiClient['export'](this.id, 'latest', 'txt', this.getByApi);
    }
  };
  return Padnews;
}());
module.exports = Padnews;
function bind$(obj, key, target){
  return function(){ return (target || obj)[key].apply(obj, arguments) };
}